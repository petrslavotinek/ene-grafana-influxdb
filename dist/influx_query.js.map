{"version":3,"sources":["../src/influx_query.js"],"names":["_","queryPart","kbn","InfluxQuery","target","templateSrv","scopedVars","policy","resultFormat","orderByTime","tags","groupBy","type","params","select","updateProjection","selectModels","map","parts","create","groupByParts","selectParts","part","def","find","g","value","stringParts","match","typePart","arg","partModel","partCount","length","push","splice","index","categories","getCategories","filter","s","category","Aggregations","Selectors","modelsIndex","indexOf","partIndex","updatePersistedParts","addStrategy","tag","interpolate","str","operator","condition","test","replace","key","measurement","variable","defaultFormatFn","multi","includeAll","regexEscape","escapedValues","join","rawQuery","query","interpolateQueryStr","i","y","selectText","render","getMeasurementAndPolicy","conditions","renderTagCondition","groupBySection","fill","limit","slimit","filters"],"mappings":"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","file":"influx_query.js","sourcesContent":["import _ from 'lodash';\nimport queryPart from './query_part';\nimport kbn from 'app/core/utils/kbn';\n\nexport default class InfluxQuery {\n  target;\n  selectModels;\n  queryBuilder;\n  groupByParts;\n  templateSrv;\n  scopedVars;\n\n  /** @ngInject */\n  constructor(target, templateSrv, scopedVars) {\n    this.target = target;\n    this.templateSrv = templateSrv;\n    this.scopedVars = scopedVars;\n\n    target.policy = target.policy || 'default';\n    target.resultFormat = target.resultFormat || 'time_series';\n    target.orderByTime = target.orderByTime || 'ASC';\n    target.tags = target.tags || [];\n    target.groupBy = target.groupBy || [{ type: 'time', params: ['$__interval'] }, { type: 'fill', params: ['null'] }];\n    target.select = target.select || [[{ type: 'field', params: ['value'] }, { type: 'mean', params: [] }]];\n\n    this.updateProjection();\n  }\n\n  updateProjection() {\n    this.selectModels = _.map(this.target.select, function(parts) {\n      return _.map(parts, queryPart.create);\n    });\n    this.groupByParts = _.map(this.target.groupBy, queryPart.create);\n  }\n\n  updatePersistedParts() {\n    this.target.select = _.map(this.selectModels, function(selectParts) {\n      return _.map(selectParts, function(part) {\n        return { type: part.def.type, params: part.params };\n      });\n    });\n  }\n\n  hasGroupByTime() {\n    return _.find(this.target.groupBy, (g) => g.type === 'time');\n  }\n\n  hasFill() {\n    return _.find(this.target.groupBy, (g) => g.type === 'fill');\n  }\n\n  addGroupBy(value) {\n    var stringParts = value.match(/^(\\w+)\\((.*)\\)$/);\n    var typePart = stringParts[1];\n    var arg = stringParts[2];\n    var partModel = queryPart.create({ type: typePart, params: [arg] });\n    var partCount = this.target.groupBy.length;\n\n    if (partCount === 0) {\n      this.target.groupBy.push(partModel.part);\n    } else if (typePart === 'time') {\n      this.target.groupBy.splice(0, 0, partModel.part);\n    } else if (typePart === 'tag') {\n      if (this.target.groupBy[partCount - 1].type === 'fill') {\n        this.target.groupBy.splice(partCount - 1, 0, partModel.part);\n      } else {\n        this.target.groupBy.push(partModel.part);\n      }\n    } else {\n      this.target.groupBy.push(partModel.part);\n    }\n\n    this.updateProjection();\n  }\n\n  removeGroupByPart(part, index) {\n    var categories = queryPart.getCategories();\n\n    if (part.def.type === 'time') {\n      // remove fill\n      this.target.groupBy = _.filter(this.target.groupBy, (g) => g.type !== 'fill');\n      // remove aggregations\n      this.target.select = _.map(this.target.select, (s) => {\n        return _.filter(s, (part) => {\n          var partModel = queryPart.create(part);\n          if (partModel.def.category === categories.Aggregations) {\n            return false;\n          }\n          if (partModel.def.category === categories.Selectors) {\n            return false;\n          }\n          return true;\n        });\n      });\n    }\n\n    this.target.groupBy.splice(index, 1);\n    this.updateProjection();\n  }\n\n  removeSelect(index) {\n    this.target.select.splice(index, 1);\n    this.updateProjection();\n  }\n\n  removeSelectPart(selectParts, part) {\n    // if we remove the field remove the whole statement\n    if (part.def.type === 'field') {\n      if (this.selectModels.length > 1) {\n        var modelsIndex = _.indexOf(this.selectModels, selectParts);\n        this.selectModels.splice(modelsIndex, 1);\n      }\n    } else {\n      var partIndex = _.indexOf(selectParts, part);\n      selectParts.splice(partIndex, 1);\n    }\n\n    this.updatePersistedParts();\n  }\n\n  addSelectPart(selectParts, type) {\n    var partModel = queryPart.create({ type: type });\n    partModel.def.addStrategy(selectParts, partModel, this);\n    this.updatePersistedParts();\n  }\n\n  renderTagCondition(tag, index, interpolate) {\n    var str = '';\n    var operator = tag.operator;\n    var value = tag.value;\n    if (index > 0) {\n      str = (tag.condition || 'AND') + ' ';\n    }\n\n    if (!operator) {\n      if (/^\\/.*\\/$/.test(value)) {\n        operator = '=~';\n      } else {\n        operator = '=';\n      }\n    }\n\n    // quote value unless regex\n    if (operator !== '=~' && operator !== '!~') {\n      if (interpolate) {\n        value = this.templateSrv.replace(value, this.scopedVars);\n      }\n      if (operator !== '>' && operator !== '<') {\n        value = \"'\" + value.replace(/\\\\/g, '\\\\\\\\') + \"'\";\n      }\n    } else if (interpolate) {\n      value = this.templateSrv.replace(value, this.scopedVars, 'regex');\n    }\n\n    return str + '\"' + tag.key + '\" ' + operator + ' ' + value;\n  }\n\n  getMeasurementAndPolicy(interpolate) {\n    var policy = this.target.policy;\n    var measurement = this.target.measurement || 'measurement';\n\n    if (!measurement.match('^/.*/$')) {\n      measurement = '\"' + measurement + '\"';\n    } else if (interpolate) {\n      measurement = this.templateSrv.replace(measurement, this.scopedVars, 'regex');\n    }\n\n    if (policy !== 'default') {\n      policy = '\"' + this.target.policy + '\".';\n    } else {\n      policy = '';\n    }\n\n    return policy + measurement;\n  }\n\n  interpolateQueryStr(value, variable, defaultFormatFn) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return kbn.regexEscape(value);\n    }\n\n    var escapedValues = _.map(value, kbn.regexEscape);\n    return '(' + escapedValues.join('|') + ')';\n  }\n\n  render(interpolate) {\n    var target = this.target;\n\n    if (target.rawQuery) {\n      if (interpolate) {\n        return this.templateSrv.replace(target.query, this.scopedVars, this.interpolateQueryStr);\n      } else {\n        return target.query;\n      }\n    }\n\n    var query = 'SELECT ';\n    var i, y;\n    for (i = 0; i < this.selectModels.length; i++) {\n      let parts = this.selectModels[i];\n      var selectText = '';\n      for (y = 0; y < parts.length; y++) {\n        let part = parts[y];\n        selectText = part.render(selectText);\n      }\n\n      if (i > 0) {\n        query += ', ';\n      }\n      query += selectText;\n    }\n\n    query += ' FROM ' + this.getMeasurementAndPolicy(interpolate) + ' WHERE ';\n    var conditions = _.map(target.tags, (tag, index) => {\n      return this.renderTagCondition(tag, index, interpolate);\n    });\n\n    if (conditions.length > 0) {\n      query += '(' + conditions.join(' ') + ') AND ';\n    }\n\n    query += '$timeFilter';\n\n    var groupBySection = '';\n    for (i = 0; i < this.groupByParts.length; i++) {\n      var part = this.groupByParts[i];\n      if (i > 0) {\n        // for some reason fill has no seperator\n        groupBySection += part.def.type === 'fill' ? ' ' : ', ';\n      }\n      groupBySection += part.render('');\n    }\n\n    if (groupBySection.length) {\n      query += ' GROUP BY ' + groupBySection;\n    }\n\n    if (target.fill) {\n      query += ' fill(' + target.fill + ')';\n    }\n\n    if (target.orderByTime === 'DESC') {\n      query += ' ORDER BY time DESC';\n    }\n\n    if (target.limit) {\n      query += ' LIMIT ' + target.limit;\n    }\n\n    if (target.slimit) {\n      query += ' SLIMIT ' + target.slimit;\n    }\n\n    return query;\n  }\n\n  renderAdhocFilters(filters) {\n    var conditions = _.map(filters, (tag, index) => {\n      return this.renderTagCondition(tag, index, false);\n    });\n    return conditions.join(' ');\n  }\n}\n"]}